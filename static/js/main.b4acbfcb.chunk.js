(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{24:function(e,n,t){e.exports=t(55)},55:function(e,n,t){"use strict";t.r(n);var a=t(1),r=t.n(a),c=t(18),i=t.n(c),o=t(4),s=t(5),u=t(6),l=t(3),h=t(7),f=t(0),d=t.n(f),p=t(2),v=function(e){return btoa(e.sdp)},w=function(e,n){return{type:n,sdp:atob(e)}},k=function(e,n,t){e[n]=Object(p.a)(d.a.mark(function a(){return d.a.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,t();case 3:a.next=8;break;case 5:a.prev=5,a.t0=a.catch(0),e[n]&&e[n]();case 8:case"end":return a.stop()}},a,null,[[0,5]])})),e[n]()},m=function(){function e(n){Object(o.a)(this,e),this.config=n}return Object(s.a)(e,[{key:"createConnectionWithOffer",value:function(){var e=Object(p.a)(d.a.mark(function e(){var n,t,a;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=this._createConnection(),t=n.createDataChannel("data"),this._configureDataChannel(t),e.next=6,n.createOffer();case 6:return a=e.sent,e.next=9,n.setLocalDescription(a);case 9:return e.abrupt("return",{connection:n,dataChannel:t});case 12:throw e.prev=12,e.t0=e.catch(0),new Error("Error initializing channel: Cannot create offer");case 15:case"end":return e.stop()}},e,this,[[0,12]])}));return function(){return e.apply(this,arguments)}}()},{key:"createConnectionWithAnswer",value:function(){var e=Object(p.a)(d.a.mark(function e(n){var t,a;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._createConnection(),e.next=4,t.setRemoteDescription(n);case 4:return e.next=6,t.createAnswer();case 6:return a=e.sent,e.next=9,t.setLocalDescription(a);case 9:return e.abrupt("return",t);case 12:throw e.prev=12,e.t0=e.catch(0),new Error("Error initializing channel: Cannot create answer");case 15:case"end":return e.stop()}},e,this,[[0,12]])}));return function(n){return e.apply(this,arguments)}}()},{key:"getOffer",value:function(){var e=Object(p.a)(d.a.mark(function e(n){var t;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.store.get(n.token);case 3:return t=e.sent,e.abrupt("return",w(t,"offer"));case 7:throw e.prev=7,e.t0=e.catch(0),new Error("Error joining channel: Cannot read offer data");case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return function(n){return e.apply(this,arguments)}}()},{key:"getAnswer",value:function(){var e=Object(p.a)(d.a.mark(function e(n){var t;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.store.get(this._getAnswerToken(n));case 3:return t=e.sent,e.abrupt("return",w(t,"answer"));case 7:throw e.prev=7,e.t0=e.catch(0),new Error("Error joining channel: Cannot read answer data");case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return function(n){return e.apply(this,arguments)}}()},{key:"saveOffer",value:function(){var e=Object(p.a)(d.a.mark(function e(n,t){var a;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._getSessionDescription(n);case 3:return a=e.sent,e.next=6,this.store.save(t.token,a);case 6:e.next=11;break;case 8:throw e.prev=8,e.t0=e.catch(0),new Error("Error initializing channel: Cannot write offer data");case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(n,t){return e.apply(this,arguments)}}()},{key:"saveAnswer",value:function(){var e=Object(p.a)(d.a.mark(function e(n,t){var a;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._getSessionDescription(n);case 3:return a=e.sent,e.next=6,this.store.save(this._getAnswerToken(t),a);case 6:e.next=11;break;case 8:throw e.prev=8,e.t0=e.catch(0),new Error("Error initializing channel: Cannot write answer data");case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(n,t){return e.apply(this,arguments)}}()},{key:"setConnectHandler",value:function(e,n,t){this._configureDataChannel(n),n.buffer=[],n.onmessage=function(e){var t=e.data;t&&n.buffer.push(t)},n.onopen=function(){return t.connect(e,n)}}},{key:"setDisconnectHandler",value:function(e,n){e.oniceconnectionstatechange=function(t){var a=e.iceConnectionState,r="failed"===a||"disconnected"===a||"closed"===a;n.isConnected&&r&&n.disconnect()}}},{key:"setWaitHandler",value:function(e,n,t){var a=this;k(n,"$waitAnswer",Object(p.a)(d.a.mark(function r(){var c;return d.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,a.getAnswer(n);case 2:return c=r.sent,r.next=5,e.setRemoteDescription(c);case 5:t();case 6:case"end":return r.stop()}},r)})))}},{key:"setUpTimeoutFor",value:function(e){var n=this.config.timeout;e.setUpTimeout(n)}},{key:"_createConnection",value:function(){return new RTCPeerConnection({iceServers:this.config.iceServers})}},{key:"_getSessionDescription",value:function(e){return new Promise(function(n){e.onicecandidate=function(t){null===t.candidate&&n(v(e.localDescription))}})}},{key:"_getAnswerToken",value:function(e){return e.token+"-answer"}},{key:"_configureDataChannel",value:function(e){e.binaryType="arraybuffer"}},{key:"store",get:function(){var e=this.config.store;if(!e)throw new Error("Store not set, use `.setStore(...)`");return e}}]),e}(),b=t(11),y=t(19),C=function(e){function n(){var e;return Object(o.a)(this,n),(e=Object(u.a)(this,Object(l.a)(n).call(this)))._pendingEvents=[],e}return Object(h.a)(n,e),Object(s.a)(n,[{key:"emit",value:function(e,t){var a=Object(b.a)(Object(l.a)(n.prototype),"emit",this).call(this,e,t);return a||this._pendingEvents.push({event:e,data:t}),a}},{key:"on",value:function(e,t){Object(b.a)(Object(l.a)(n.prototype),"on",this).call(this,e,t);var a=function(n){return n.event===e};return this._pendingEvents.filter(a).forEach(function(e){e.event;var n=e.data;return t(n)}),this._pendingEvents=this._pendingEvents.filter(function(e){return!a(e)}),this}}]),n}(t.n(y).a),O=t(20),j=t.n(O),g=function(e){function n(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:j()();return Object(o.a)(this,n),(e=Object(u.a)(this,Object(l.a)(n).call(this))).token=t,e.connection=null,e.dataChannel=null,e.$timeout=null,e.didDisconnect=!1,e.didTimeout=!1,e}return Object(h.a)(n,e),Object(s.a)(n,[{key:"send",value:function(e){this._checkConnected(),this.dataChannel.send(e)}},{key:"disconnect",value:function(){this.didDisconnect=!0;var e=this.isConnected;this.dataChannel&&this.dataChannel.close(),this.connection&&this.connection.close(),this.connection=null,this.dataChannel=null,this.$waitAnswer=null,e&&this.emit("disconnected"),this._clearTimeout()}},{key:"connect",value:function(e,n){var t=this;this._checkNotConnected(),this.connection=e,this.dataChannel=n;n.buffer&&(n.buffer.forEach(function(e){return t.emit("data",e)}),delete n.buffer),this.dataChannel.onmessage=function(e){var n=e.data;n&&t.emit("data",n)},this.emit("connected"),this._clearTimeout()}},{key:"setUpTimeout",value:function(e){var n=this;this.$timeout=setTimeout(function(){n.isConnected||(n.didTimeout=!0,n.disconnect(),n.emit("timeout"))},e)}},{key:"_clearTimeout",value:function(){clearTimeout(this.$timeout),this.$timeout=null}},{key:"_checkConnected",value:function(){if(!this.isConnected)throw new Error("Error: Not connected")}},{key:"_checkNotConnected",value:function(){if(this.isConnected)throw new Error("Error: Already connected")}},{key:"isConnected",get:function(){return null!==this.dataChannel}}]),n}(C),E=t(9),_=function(e){function n(e,t){var a;return Object(o.a)(this,n),(a=Object(u.a)(this,Object(l.a)(n).call(this)))._handleConnection=a._handleConnection.bind(Object(E.a)(Object(E.a)(a))),a._handleDisconnection=a._handleDisconnection.bind(Object(E.a)(Object(E.a)(a))),a._handleData=a._handleData.bind(Object(E.a)(Object(E.a)(a))),a.channel1=e,a.channel2=null,a.selectedChannel=null,a._subscribeChannel(a.channel1,function(){return a.channel2}),t&&a.connect(t),a.didTimeout=!1,a}return Object(h.a)(n,e),Object(s.a)(n,[{key:"send",value:function(e){this._checkConnected(),this.selectedChannel.send(e)}},{key:"disconnect",value:function(){this.channel1.disconnect(),this.channel2&&this.channel2.disconnect(),this._clean()}},{key:"connect",value:function(e){var n=this;this.channel2=e,this._subscribeChannel(this.channel2,function(){return n.channel1})}},{key:"_checkConnected",value:function(){if(!this.isConnected)throw new Error("Error: Not connected")}},{key:"_subscribeChannel",value:function(e,n){var t=this;e.on("connected",function(){t._handleConnection(e)}).on("disconnected",function(){t._handleDisconnection(e,n())}).on("timeout",function(){t._handleTimeout(e,n())}).on("data",this._handleData)}},{key:"_handleConnection",value:function(e){this.isConnected||(this.selectedChannel=e,this.emit("connected"))}},{key:"_handleDisconnection",value:function(e,n){var t=this.isConnected;n&&n.isConnected?this.selectedChannel=n:t&&(this._clean(),this.emit("disconnected"))}},{key:"_handleTimeout",value:function(e,n){!e.didTimeout&&!n.didTimeout||this.isConnected||this.didTimeout||(this.didTimeout=!0,this.disconnect(),this.emit("timeout"))}},{key:"_handleData",value:function(e){this.emit("data",e)}},{key:"_clean",value:function(){this.selectedChannel=null,this.$waitChannel2=null}},{key:"token",get:function(){return this.channel1.token}},{key:"isConnected",get:function(){return null!==this.selectedChannel}}]),n}(C),x=t(21),T=t.n(x),D=function(){function e(n){Object(o.a)(this,e),this.api=T.a.create({baseURL:n,headers:{cache:"no-cache"}})}return Object(s.a)(e,[{key:"get",value:function(e){return this.api.get("get/".concat(e)).then(this._adaptResponse)}},{key:"save",value:function(e,n){var t=encodeURIComponent(n);return this.api.get("set/".concat(e,"/").concat(t)).then(this._adaptResponse)}},{key:"_adaptResponse",value:function(e){return e.data.value}}]),e}(),S={store:null,iceServers:[{urls:"stun:stun.l.google.com:19302"}],timeout:1e4},A=new m(S),W={createChannel:function(){var e=Object(p.a)(d.a.mark(function e(){var n,t,a=this;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.createSingleChannel();case 2:return n=e.sent,t=new _(n),k(t,"$waitChannel2",Object(p.a)(d.a.mark(function e(){var n;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.joinSingleChannel(t.token+"-2");case 2:n=e.sent,t.connect(n);case 4:case"end":return e.stop()}},e)}))),e.abrupt("return",t);case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),joinChannel:function(){var e=Object(p.a)(d.a.mark(function e(n){var t,a;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.joinSingleChannel(n);case 2:return t=e.sent,e.next=5,this.createSingleChannel(n+"-2");case 5:return a=e.sent,e.abrupt("return",new _(t,a));case 7:case"end":return e.stop()}},e,this)}));return function(n){return e.apply(this,arguments)}}(),createSingleChannel:function(){var e=Object(p.a)(d.a.mark(function e(n){var t,a,r,c;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new g(n),e.next=3,A.createConnectionWithOffer();case 3:return a=e.sent,r=a.connection,c=a.dataChannel,A.setConnectHandler(r,c,t),A.setDisconnectHandler(r,t),A.setWaitHandler(r,t,function(){return A.setUpTimeoutFor(t)}),e.next=11,A.saveOffer(r,t);case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}},e)}));return function(n){return e.apply(this,arguments)}}(),joinSingleChannel:function(){var e=Object(p.a)(d.a.mark(function e(n){var t,a,r;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new g(n),e.next=3,A.getOffer(t);case 3:return a=e.sent,e.next=6,A.createConnectionWithAnswer(a);case 6:return r=e.sent,e.next=9,A.saveAnswer(r,t);case 9:return A.setUpTimeoutFor(t),r.ondatachannel=function(e){var n=e.channel;A.setConnectHandler(r,n,t)},A.setDisconnectHandler(r,t),e.abrupt("return",t);case 13:case"end":return e.stop()}},e)}));return function(n){return e.apply(this,arguments)}}(),setStore:function(e){S.store=e},setIceServers:function(e){S.iceServers=e},setTimeout:function(e){S.timeout=e}},U=t(22),M=t.n(U),H=function(){return window.location.href.replace(window.location.hash,"").replace(window.location.search,"")},I=function(){return M.a.parse(window.location.search.replace("?",""))},N=function(e){function n(){var e,t;Object(o.a)(this,n);for(var a=arguments.length,r=new Array(a),c=0;c<a;c++)r[c]=arguments[c];return(t=Object(u.a)(this,(e=Object(l.a)(n)).call.apply(e,[this].concat(r)))).state={token:null},t}return Object(h.a)(n,e),Object(s.a)(n,[{key:"render",value:function(){return this.state.token?r.a.createElement("div",null,"Send this link to your peer and wait...",r.a.createElement("br",null),r.a.createElement("br",null),r.a.createElement("a",{href:this.link},this.link)):r.a.createElement("div",null,"Wait...")}},{key:"componentDidMount",value:function(){var e=Object(p.a)(d.a.mark(function e(){return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return window.channel&&window.channel.disconnect(),e.next=3,W.createChannel();case 3:window.channel=this.channel=e.sent,this.setState({token:this.channel.token}),this.channel.on("connected",function(){window.location.hash="#/chat"}),this.channel.on("timeout",function(){alert("TIMEOUT!"),window.location.hash="#/"});case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"link",get:function(){var e=H();return"".concat(e,"?token=").concat(this.state.token,"#/join")}}]),n}(a.Component),R=function(e){function n(){return Object(o.a)(this,n),Object(u.a)(this,Object(l.a)(n).apply(this,arguments))}return Object(h.a)(n,e),Object(s.a)(n,[{key:"render",value:function(){return this.inviteToken?r.a.createElement("div",null,"Wait..."):r.a.createElement("div",null,"Invalid token.")}},{key:"componentDidMount",value:function(){var e=Object(p.a)(d.a.mark(function e(){var n=this;return d.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.inviteToken){e.next=2;break}return e.abrupt("return");case 2:return window.channel&&window.channel.disconnect(),e.next=5,W.joinChannel(this.inviteToken);case 5:window.channel=this.channel=e.sent,this.channel.on("connected",function(){window.channel=n.channel,window.location.hash="#/chat"}),this.channel.on("timeout",function(){alert("TIMEOUT!"),window.location.hash="#/"});case 8:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"inviteToken",get:function(){return I().token||null}}]),n}(a.Component),$=t(23),L=function(e){function n(){var e,t;Object(o.a)(this,n);for(var a=arguments.length,r=new Array(a),c=0;c<a;c++)r[c]=arguments[c];return(t=Object(u.a)(this,(e=Object(l.a)(n)).call.apply(e,[this].concat(r)))).state={messages:[],input:""},t}return Object(h.a)(n,e),Object(s.a)(n,[{key:"render",value:function(){var e=this;return window.channel?r.a.createElement("div",null,r.a.createElement("textarea",{value:this.state.messages.join("\n"),readOnly:!0,rows:15,ref:function(n){return e.textarea=n},style:{width:"100%"}}),r.a.createElement("br",null),r.a.createElement("input",{type:"text",value:this.state.input,onChange:function(n){e.setState({input:n.target.value})},onKeyDown:function(n){var t=e.state.input;"Enter"===n.key&&t&&(window.channel.send(t),e.setState({input:""}),e._addMessage("Me: ".concat(t)))},ref:function(n){return e.input=n},style:{width:"100%"}})):r.a.createElement("div",null,"No connection.")}},{key:"componentDidMount",value:function(){var e=this,n=window.channel;n&&(n.on("data",function(n){e._addMessage("Stranger: ".concat(n))}),n.on("disconnected",function(){alert("DISCONNECTED!"),window.location.hash="#/"}),this.input.focus())}},{key:"componentWillUnmount",value:function(){window.channel&&(window.channel.disconnect(),window.channel=void 0)}},{key:"_addMessage",value:function(e){var n=this;this.setState({messages:[].concat(Object($.a)(this.state.messages),[e])},function(){n.textarea.scrollTop=n.textarea.scrollHeight})}}]),n}(a.Component);W.setStore(new D("https://misc.r-labs.io"));var z=function(e){function n(){return Object(o.a)(this,n),Object(u.a)(this,Object(l.a)(n).apply(this,arguments))}return Object(h.a)(n,e),Object(s.a)(n,[{key:"render",value:function(){var e=window.location.hash;return e.startsWith("#/create")?r.a.createElement(N,null):e.startsWith("#/join")?r.a.createElement(R,null):e.startsWith("#/chat")?r.a.createElement(L,null):r.a.createElement("div",null,r.a.createElement("h1",null,"Valid urls:"),r.a.createElement("a",{href:"#/create"},"/#/create"),r.a.createElement("br",null),"/#/join?token=INVITE_TOKEN",r.a.createElement("br",null),r.a.createElement("br",null),">"," ",r.a.createElement("a",{href:"https://github.com/afska/quickp2p",target:"_blank",rel:"noopener noreferrer"},"Source code and instructions"))}},{key:"componentWillMount",value:function(){var e=this;this._listener=window.addEventListener("hashchange",function(n){e.forceUpdate()})}},{key:"componentWillUnmount",value:function(){window.removeEventListener("hashchange",this._listener)}}]),n}(a.Component);i.a.render(r.a.createElement(z,null),document.getElementById("root"))}},[[24,1,2]]]);
//# sourceMappingURL=main.b4acbfcb.chunk.js.map